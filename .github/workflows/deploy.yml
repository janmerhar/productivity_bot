name: Deploy to VPS

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Write .env file
        if: ${{ secrets.ENV_FILE != '' }}
        run: |
          printf '%s' "${{ secrets.ENV_FILE }}" > .env
          chmod 600 .env

      - name: Load SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Trust VPS host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}

      - name: Sync project to VPS
        run: |
          rsync -az --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude '__pycache__/' \
            ./ "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH"
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}

      - name: Run remote deploy script
        run: |
          ssh "$DEPLOY_USER@$DEPLOY_HOST" "cd '$DEPLOY_PATH' && ${DEPLOY_COMMAND:-./deploy.sh}"
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_COMMAND: ${{ secrets.DEPLOY_COMMAND }}
